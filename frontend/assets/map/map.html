<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>ZeroWaste Kakao Map</title>
  <style>
    html, body, #map { height: 100%; margin: 0; padding: 0; }
    #map { position: relative; }

    #selectOverlay {
      position: absolute; display: none; transform: translate(-50%, -100%);
      background: #fff; border-radius: 12px; box-shadow: 0 4px 16px rgba(0,0,0,.2);
      padding: 8px 10px; font-size: 14px; user-select: none;
      z-index: 9999;
      pointer-events: auto;
      /* 중앙 고정 버튼처럼 보이게 가운데에 배치 */
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
    }
    #selectOverlay .btn {
      border: 0; border-radius: 8px; padding: 6px 10px; font-weight: 700;
      background: #2f7d32; color: #fff; cursor: pointer;
    }
    #selectOverlay .txt { margin-bottom: 6px; font-size: 12px; opacity: .8; text-align:center; }
  </style>
  <script>
    window.onerror = function(msg, src, line, col, err){
      try { KakaoBridge.postMessage(JSON.stringify({type:'js_error', msg, src, line, col})); } catch(e) {}
    };
    function post(msg){ try { KakaoBridge.postMessage(msg); } catch(e) { console.log(msg); } }
  </script>
  <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=a9485d1836815b45b710a9e381f79806"
          onload="post('KAKAO_SDK_LOADED')"
          onerror="post('KAKAO_SDK_ERROR')"></script>
</head>
<body>
  <div id="map">
    <div id="selectOverlay">
      <div id="coordText" class="txt">위치 선택됨</div>
      <button id="pickBtn" class="btn">이 위치로 제보</button>
    </div>
  </div>

<script>
  let map; let centerMarker; let myLocationMarker;

  // 중앙 선택 좌표
  let selectedLatLng = null;
  const overlayEl = document.getElementById('selectOverlay');
  const coordTextEl = document.getElementById('coordText');

  overlayEl.addEventListener('click', (ev) => ev.stopPropagation());
  overlayEl.addEventListener('touchstart', (ev) => ev.stopPropagation(), { passive: true });

  function initMap(lat, lng, level){
    if(!window.kakao || !kakao.maps){ post('KAKAO_NOT_READY'); return; }
    const container = document.getElementById('map');
    const options = { center: new kakao.maps.LatLng(lat||37.5665, lng||126.9780), level: level||4 };
    map = new kakao.maps.Map(container, options);

    // 화면 중앙에 고정된 마커(지도의 center를 따라감)
    centerMarker = new kakao.maps.Marker({ position: map.getCenter(), zIndex: 90 });
    centerMarker.setMap(map);

    // 초기 텍스트/상태
    selectedLatLng = map.getCenter();
    coordTextEl.textContent = `위도 ${selectedLatLng.getLat().toFixed(5)} / 경도 ${selectedLatLng.getLng().toFixed(5)}`;
    overlayEl.style.display = 'block';

    // 지도의 중심이 바뀔 때마다 선택 좌표도 갱신
    kakao.maps.event.addListener(map, 'center_changed', function(){
      selectedLatLng = map.getCenter();
      if (centerMarker) centerMarker.setPosition(selectedLatLng);
      coordTextEl.textContent = `위도 ${selectedLatLng.getLat().toFixed(5)} / 경도 ${selectedLatLng.getLng().toFixed(5)}`;
    });

    // "이 위치로 제보" 버튼 → 현재 중심 좌표 전달
    document.getElementById('pickBtn').addEventListener('click', function(){
      if(!selectedLatLng) return;
      post(JSON.stringify({
        type: 'location_selected',
        lat: selectedLatLng.getLat(),
        lng: selectedLatLng.getLng()
      }));
    });

    post('MAP_INIT_DONE');
  }

  function moveTo(lat, lng){
    if(!map) return;
    const pos = new kakao.maps.LatLng(lat, lng);
    map.setCenter(pos);
    if(centerMarker) centerMarker.setPosition(pos);
    selectedLatLng = pos;
    coordTextEl.textContent = `위도 ${pos.getLat().toFixed(5)} / 경도 ${pos.getLng().toFixed(5)}`;
    overlayEl.style.display = 'block';
  }

  // 내 위치 마커
  function setMyLocation(lat, lng){
    if(!map) return;
    const pos = new kakao.maps.LatLng(lat, lng);
    if (!myLocationMarker) {
      myLocationMarker = new kakao.maps.Marker({ position: pos, zIndex: 100 });
      myLocationMarker.setMap(map);
    } else {
      myLocationMarker.setPosition(pos);
      if(!myLocationMarker.getMap()) myLocationMarker.setMap(map);
    }
  }

  // 선택 해제(오버레이 숨김만 유지)
  function clearSelection(){
    selectedLatLng = null;
    overlayEl.style.display = 'none';
  }

  // 외부 노출
  window.initMap = initMap;
  window.moveTo = moveTo;
  window.setMyLocation = setMyLocation;
  window.clearSelection = clearSelection;
</script>
</body>
</html>
