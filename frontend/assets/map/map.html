<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ZeroWaste Map</title>

  <style>
    html, body {
      width: 100vw; height: 100vh;
      margin: 0; padding: 0; overflow: hidden;
      background: #fff;
    }
    /* 지도가 전체 화면을 덮도록 고정 */
    #map {
      position: fixed; inset: 0;
      width: 100vw; height: 100vh;
      display: block; max-width: none !important;
      z-index: 0;
    }
    /* 혹시 외부 스타일의 max-width 영향 차단 */
    img, svg, canvas { max-width: none !important; }
  </style>

  <!-- 카카오 지도 SDK: YOUR_KAKAO_APP_KEY를 실제 앱키로 교체 -->
  <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=a9485d1836815b45b710a9e381f79806"></script>
</head>
<body>
  <div id="map"></div>

  <script>
    let map;
    // Flutter에서 추가한 마커 보관 (필터에 사용)
    // 형식: { marker, category }
    const markers = [];

    // 카테고리 → 색상 매핑
    const CATEGORY_COLORS = {
      'CIGARETTE_BUTT': '#e53935', // 빨강
      'GENERAL_WASTE' : '#1e88e5', // 파랑
      'FOOD_WASTE'    : '#43a047', // 초록
      'OTHERS'        : '#6d4c41', // 브라운
    };

    function init() {
      const container = document.getElementById('map');
      map = new kakao.maps.Map(container, {
        center: new kakao.maps.LatLng(37.5665, 126.9780), // 서울 시청
        level: 3  //Default: 4
      });

      // 지도 이동/로드 이벤트 → 중심 좌표를 Flutter로 전달
      kakao.maps.event.addListener(map, 'dragend', emitCenter);
      kakao.maps.event.addListener(map, 'tilesloaded', emitCenter);

      // 뷰포트 준비/변경 시 bounds도 전달 (초기 1회 포함)
      kakao.maps.event.addListener(map, 'tilesloaded', emitBounds);
      kakao.maps.event.addListener(map, 'idle', emitBounds);
      kakao.maps.event.addListener(map, 'zoom_changed', emitBounds);

      if (window.MapChannel) {
        window.MapChannel.postMessage('READY');
        setTimeout(emitBounds, 0); // 초기 1회 보장
      }
    }

    // 현재 중심 좌표를 "lat,lng" 문자열로 Flutter에 전송
    function emitCenter() {
      if (!map || !window.MapChannel) return;
      const c = map.getCenter();
      window.MapChannel.postMessage(`${c.getLat()},${c.getLng()}`);
    }

    function emitBounds() {
      if (!map || !window.MapChannel) return;
      const b = map.getBounds();
      const sw = b.getSouthWest(); // 남서
      const ne = b.getNorthEast(); // 북동
      const level = map.getLevel();
      // BOUNDS:south,west,north,east,level
      window.MapChannel.postMessage(`BOUNDS:${sw.getLat()},${sw.getLng()},${ne.getLat()},${ne.getLng()},${level}`);
    }

    // ────────────── Flutter에서 호출할 공개 함수들 ──────────────

    // 중심 이동
    window.setCenter = function(lat, lng) {
      if (!map) return;
      map.setCenter(new kakao.maps.LatLng(lat, lng));
      // 이동 후 중심 재전송(선택)
      emitCenter();
    };

    window.getBounds = function() {
      if (!map) return null;
      const b = map.getBounds();
      const sw = b.getSouthWest();
      const ne = b.getNorthEast();
      const level = map.getLevel();
      return { south: sw.getLat(), west: sw.getLng(), north: ne.getLat(), east: ne.getLng(), level };
    };

    // 줌 레벨 설정 (숫자 작을수록 확대됨)
    window.setZoomLevel = function(level) {
      if (!map) return;
      map.setLevel(Number(level));
    };

    // 마커 추가 (카테고리별 색상 원형 SVG)
    window.addMarker = function(lat, lng, category) {
      if (!map) return;

      const color = CATEGORY_COLORS[category] || '#ff5252';
      const svg = `
        <svg width="28" height="28" viewBox="0 0 28 28" xmlns="http://www.w3.org/2000/svg">
          <circle cx="14" cy="14" r="10" fill="${color}" stroke="white" stroke-width="2"/>
        </svg>
      `;
      const markerImage = new kakao.maps.MarkerImage(
        'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(svg),
        new kakao.maps.Size(28, 28),
        { offset: new kakao.maps.Point(14, 14) } // 중심 정렬
      );

      const marker = new kakao.maps.Marker({
        position: new kakao.maps.LatLng(lat, lng),
        image: markerImage,
        map,
      });

      markers.push({ marker, category });

      // (디버그) 추가 확인 로그를 Flutter로
      if (window.MapChannel) {
        window.MapChannel.postMessage(`ADDED:${lat},${lng},${category},count=${markers.length}`);
      }
    };

    // 카테고리 필터: null/undefined 이면 전체 표시
    window.filterByCategory = function(categoryOrNull) {
      markers.forEach(({ marker, category }) => {
        const show = !categoryOrNull || category === categoryOrNull;
        marker.setMap(show ? map : null);
      });
    };

    // 모든 마커 제거
    window.clearMarkers = function() {
      markers.forEach(({ marker }) => marker.setMap(null));
      markers.length = 0;
    };

    // ──────────────────────────────────────────────────────────

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
